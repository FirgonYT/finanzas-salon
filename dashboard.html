<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - Finanzas Salón</title>
  <style>
    /* CSS base */
    body { margin: 0; font-family: Arial, sans-serif; background: #f4f4f4; }
    #sidebar {
      background-color: #d43939;
      width: 200px;
      height: 100vh;
      position: fixed;
      top: 0; left: 0;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #sidebar button {
      background: transparent;
      border: none;
      color: white;
      padding: 15px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-left: 5px solid transparent;
      transition: 0.3s;
      outline: none;
    }
    #sidebar button:hover, #sidebar button.active {
      background-color: #b22b2b;
      border-left: 5px solid #ff726f;
    }
    #main-content {
      margin-left: 200px;
      padding: 20px;
      min-height: 100vh;
    }
    section { display: none; }
    section.active { display: block; }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    input, select, textarea {
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-family: inherit;
    }
    button.submit-btn {
      background-color: #d43939;
      border: none;
      color: white;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 15px;
      font-weight: bold;
      transition: background-color 0.3s ease;
      outline: none;
    }
    button.submit-btn:hover {
      background-color: #b22b2b;
    }
    .status-pagado { color: green; font-weight: bold; }
    .status-menor-pago { color: orange; font-weight: bold; }
    .status-no-pagado { color: red; font-weight: bold; }
    .boton-ver-pagos, .boton-eliminar-pago, .boton-generar-factura, .boton-eliminar-egreso {
      background-color: #444;
      border: none;
      color: white;
      padding: 5px 8px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 5px;
      transition: background-color 0.3s ease;
      outline: none;
    }
    .boton-ver-pagos:hover, .boton-eliminar-pago:hover, .boton-generar-factura:hover, .boton-eliminar-egreso:hover {
      background-color: #666;
    }
    /* Separador de meses en detalle pagos */
    .mes-separador {
      background-color: #eee;
      font-weight: bold;
      padding: 8px 10px;
      border-top: 2px solid #ccc;
      border-bottom: 2px solid #ccc;
      text-align: center;
      font-size: 16px;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <button class="active" onclick="showSection('estudiantes')">Estudiantes</button>
    <button onclick="showSection('pagos')">Pagos</button>
    <button onclick="showSection('finanzas')">Finanzas</button>
    <button onclick="showSection('egresos')">Egresos</button>
    <button onclick="logout()">Salir</button>
  </div>

  <div id="main-content">
    <!-- Sección Estudiantes -->
    <section id="estudiantes" class="active">
      <h2>Agregar Estudiante</h2>
      <input type="text" id="estudiante-nombre" placeholder="Nombre completo" />
      <button class="submit-btn" onclick="agregarEstudiante()">Añadir Estudiante</button>

      <h3>Lista de Estudiantes (Estado pago mes actual)</h3>
      <table id="tabla-estudiantes">
        <thead><tr><th>Nombre</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Sección Registrar Pago -->
    <section id="pagos">
      <h2>Registrar Pago de Estudiante</h2>
      <label for="select-estudiante">Seleccione estudiante:</label>
      <select id="select-estudiante"></select>

      <label for="pago-monto">Monto (COP):</label>
      <input type="number" id="pago-monto" placeholder="Ejemplo: 50000" />

      <button class="submit-btn" onclick="registrarPago()">Registrar Pago</button>
    </section>

    <!-- Sección Detalle Pagos Estudiante -->
    <section id="detalle-pagos">
      <h2>Pagos del estudiante: <span id="nombre-estudiante-detalle"></span></h2>
      <button class="submit-btn" onclick="volverAEstudiantes()">Volver a lista de estudiantes</button>
      <table id="tabla-pagos-detalle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Monto (COP)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>Total Pagado este mes</th>
            <th id="total-pagado"></th>
            <th></th>
          </tr>
          <tr>
            <th>Estado</th>
            <th id="estado-pago-detalle"></th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </section>

    <!-- Sección Finanzas -->
    <section id="finanzas">
      <h2>Finanzas</h2>
      <p><strong>Ingresos Totales (pagos):</strong> COP <span id="total-ingresos">0</span></p>
      <p><strong>Egresos Totales:</strong> COP <span id="total-egresos">0</span></p>
      <p><strong>Balance:</strong> COP <span id="balance">0</span></p>
    </section>

    <!-- Sección Egresos -->
    <section id="egresos">
      <h2>Registrar Egreso</h2>
      <label for="descripcion-egreso">Descripción:</label>
      <input type="text" id="descripcion-egreso" placeholder="Ejemplo: Compra de materiales" />
      <label for="monto-egreso">Monto (COP):</label>
      <input type="number" id="monto-egreso" placeholder="Ejemplo: 100000" />
      <button class="submit-btn" onclick="registrarEgreso()">Registrar Egreso</button>

      <h3>Lista de Egresos</h3>
      <table id="tabla-egresos">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripción</th>
            <th>Monto (COP)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmiMMw8d39YhXJ7JaTnsiZlExiNvoC9rk",
      authDomain: "finanzas-salon.firebaseapp.com",
      projectId: "finanzas-salon",
      storageBucket: "finanzas-salon.firebasestorage.app",
      messagingSenderId: "550307448425",
      appId: "1:550307448425:web:dd755a9ad2a22e009044f8",
      measurementId: "G-MXET3PGMF8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Datos básicos y constantes
    const MES_ACTUAL = new Date().getMonth() + 1; // Enero=1 ... Diciembre=12
    const ANIO_ACTUAL = new Date().getFullYear();
    const MONTO_MENSUAL_ESPERADO = 50000; // Valor fijo mensual esperado para cada estudiante

    // DOM Elements
    const btnsSidebar = document.querySelectorAll('#sidebar button');
    const sections = document.querySelectorAll('section');
    const tablaEstudiantesBody = document.querySelector('#tabla-estudiantes tbody');
    const selectEstudiante = document.getElementById('select-estudiante');

    const detallePagosSection = document.getElementById('detalle-pagos');
    const nombreEstudianteDetalleSpan = document.getElementById('nombre-estudiante-detalle');
    const tablaPagosDetalleBody = document.querySelector('#tabla-pagos-detalle tbody');
    const totalPagadoSpan = document.getElementById('total-pagado');
    const estadoPagoDetalleSpan = document.getElementById('estado-pago-detalle');

    const totalIngresosSpan = document.getElementById('total-ingresos');
    const totalEgresosSpan = document.getElementById('total-egresos');
    const balanceSpan = document.getElementById('balance');

    const tablaEgresosBody = document.querySelector('#tabla-egresos tbody');

    // Variables de estado
    let estudiantesCache = [];
    let egresosCache = [];

    // Para recordar el estudiante que se está viendo en detalle de pagos
    let estudianteSeleccionado = null;

    // Manejar visibilidad de secciones y botones sidebar
    function showSection(id) {
      sections.forEach(sec => sec.classList.remove('active'));
      const sectionToShow = document.getElementById(id);
      if (!sectionToShow) return;

      sectionToShow.classList.add('active');

      btnsSidebar.forEach(btn => {
        if (btn.textContent.toLowerCase() === id.toLowerCase()) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // En "Pagos" actualizar select de estudiantes
      if (id === 'pagos') {
        actualizarSelectEstudiantes();
      }
      // En "Estudiantes" mostrar listado actualizado
      if (id === 'estudiantes') {
        cargarEstudiantes();
      }
      // En "Finanzas" actualizar resumen
      if (id === 'finanzas') {
        calcularFinanzas();
      }
      // En "Egresos" cargar egresos
      if (id === 'egresos') {
        cargarEgresos();
      }
    }

    // Logout function
    function logout() {
      signOut(auth)
        .then(() => {
          window.location.href = 'index.html';
        })
        .catch(error => {
          alert('Error al cerrar sesión: ' + error.message);
        });
    }

    // Inicialización: verificar usuario logueado
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        // Usuario autenticado, cargar datos iniciales
        cargarEstudiantes();
        cargarEgresos();
        calcularFinanzas();
      }
    });

    // --- ESTUDIANTES ---

    // Agregar estudiante nuevo
    async function agregarEstudiante() {
      const nombre = document.getElementById('estudiante-nombre').value.trim();
      if (nombre.length < 2) {
        alert('Por favor ingresa un nombre válido.');
        return;
      }

      try {
        await addDoc(collection(db, 'estudiantes'), {
          nombre,
          creadoEn: new Date()
        });
        document.getElementById('estudiante-nombre').value = '';
        alert('Estudiante agregado correctamente.');
        cargarEstudiantes();
      } catch (error) {
        alert('Error al agregar estudiante: ' + error.message);
      }
    }

    // Cargar estudiantes y mostrar tabla
    async function cargarEstudiantes() {
      tablaEstudiantesBody.innerHTML = '';
      estudiantesCache = [];

      try {
        const snapshot = await getDocs(collection(db, 'estudiantes'));
        snapshot.forEach(docSnap => {
          const estudiante = { id: docSnap.id, ...docSnap.data() };
          estudiantesCache.push(estudiante);
        });

        if (estudiantesCache.length === 0) {
          tablaEstudiantesBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay estudiantes registrados.</td></tr>';
          return;
        }

        // Por cada estudiante mostrar estado del pago mes actual y botón ver pagos
        for (const estudiante of estudiantesCache) {
          const estadoPago = await calcularEstadoPago(estudiante.id, MES_ACTUAL, ANIO_ACTUAL);
          const estadoHTML = estadoPago.estado === 'pagado' ? `<span class="status-pagado">Pagado</span>`
                           : estadoPago.estado === 'menor' ? `<span class="status-menor-pago">Pago incompleto</span>`
                           : `<span class="status-no-pagado">No pagado</span>`;

          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${estudiante.nombre}</td>
            <td>${estadoHTML}</td>
            <td>
              <button class="boton-ver-pagos" onclick="verPagosEstudiante('${estudiante.id}', '${escapeHtml(estudiante.nombre)}')">Ver pagos</button>
            </td>
          `;

          tablaEstudiantesBody.appendChild(tr);
        }
      } catch (error) {
        alert('Error al cargar estudiantes: ' + error.message);
      }
    }

    // Actualizar select para registrar pagos
    function actualizarSelectEstudiantes() {
      selectEstudiante.innerHTML = '';
      if (estudiantesCache.length === 0) {
        selectEstudiante.innerHTML = '<option value="">No hay estudiantes</option>';
        return;
      }
      selectEstudiante.innerHTML = '<option value="">-- Seleccione un estudiante --</option>';
      estudiantesCache.forEach(est => {
        selectEstudiante.innerHTML += `<option value="${est.id}">${escapeHtml(est.nombre)}</option>`;
      });
    }

    // --- PAGOS ---

    // Registrar pago
    async function registrarPago() {
      const idEstudiante = selectEstudiante.value;
      const montoStr = document.getElementById('pago-monto').value.trim();

      if (!idEstudiante) {
        alert('Seleccione un estudiante.');
        return;
      }

      const monto = Number(montoStr);
      if (isNaN(monto) || monto <= 0) {
        alert('Ingrese un monto válido mayor a 0.');
        return;
      }

      // Guardar pago con fecha actual
      try {
        await addDoc(collection(db, 'pagos'), {
          estudianteId: idEstudiante,
          monto,
          fecha: new Date()
        });
        alert('Pago registrado correctamente.');
        document.getElementById('pago-monto').value = '';
      } catch (error) {
        alert('Error al registrar pago: ' + error.message);
      }
    }

    // Calcular estado pago de un estudiante para mes y año dados
    async function calcularEstadoPago(estudianteId, mes, anio) {
      // Traer pagos de ese estudiante en ese mes y año
      const pagosRef = collection(db, 'pagos');
      const q = query(
        pagosRef,
        where('estudianteId', '==', estudianteId),
        where('fecha', '>=', new Date(anio, mes - 1, 1, 0, 0, 0)),
        where('fecha', '<=', new Date(anio, mes - 1, 31, 23, 59, 59))
      );

      try {
        const snapshot = await getDocs(q);
        let suma = 0;
        snapshot.forEach(docSnap => {
          const pago = docSnap.data();
          suma += pago.monto;
        });

        if (suma >= MONTO_MENSUAL_ESPERADO) {
          return { estado: 'pagado', total: suma };
        } else if (suma > 0) {
          return { estado: 'menor', total: suma };
        } else {
          return { estado: 'no', total: 0 };
        }
      } catch {
        return { estado: 'no', total: 0 };
      }
    }

    // Ver detalle de pagos de un estudiante (mostrar todos los pagos agrupados por mes)
    async function verPagosEstudiante(idEstudiante, nombre) {
      estudianteSeleccionado = idEstudiante;
      nombreEstudianteDetalleSpan.textContent = nombre;
      tablaPagosDetalleBody.innerHTML = '';
      totalPagadoSpan.textContent = '';
      estadoPagoDetalleSpan.textContent = '';

      // Ocultar otras secciones y mostrar detalle pagos
      sections.forEach(sec => sec.classList.remove('active'));
      detallePagosSection.classList.add('active');

      try {
        // Obtener todos los pagos de ese estudiante, ordenados por fecha ascendente
        const pagosRef = collection(db, 'pagos');
        const q = query(pagosRef, where('estudianteId', '==', idEstudiante), orderBy('fecha', 'desc'));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          tablaPagosDetalleBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay pagos registrados.</td></tr>';
          totalPagadoSpan.textContent = '0';
          estadoPagoDetalleSpan.textContent = 'No pagado';
          return;
        }

        // Agrupar pagos por mes y año
        const pagosPorMes = {}; // clave: "YYYY-MM", valor: array de pagos
        snapshot.forEach(docSnap => {
          const pago = docSnap.data();
          const fecha = pago.fecha.toDate ? pago.fecha.toDate() : new Date(pago.fecha);
          const keyMes = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
          if (!pagosPorMes[keyMes]) pagosPorMes[keyMes] = [];
          pagosPorMes[keyMes].push({ id: docSnap.id, monto: pago.monto, fecha });
        });

        // Mostrar agrupado por mes (descendente)
        let totalPagadoMesActual = 0;
        for (const keyMes of Object.keys(pagosPorMes).sort((a,b) => b.localeCompare(a))) {
          // Separador mes
          const [anio, mes] = keyMes.split('-');
          const fechaMes = new Date(anio, parseInt(mes) - 1);
          const nombreMes = fechaMes.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' });
          const trMes = document.createElement('tr');
          trMes.classList.add('mes-separador');
          trMes.innerHTML = `<td colspan="3">${capitalize(nombreMes)}</td>`;
          tablaPagosDetalleBody.appendChild(trMes);

          // Mostrar pagos de ese mes
          for (const pago of pagosPorMes[keyMes]) {
            const trPago = document.createElement('tr');
            trPago.innerHTML = `
              <td>${formatFecha(pago.fecha)}</td>
              <td>${formatoMoneda(pago.monto)}</td>
              <td>
                <button class="boton-eliminar-pago" onclick="eliminarPago('${pago.id}')">Eliminar</button>
              </td>
            `;
            tablaPagosDetalleBody.appendChild(trPago);
          }

          // Si es mes actual, sumar para el total y estado
          if (parseInt(anio) === ANIO_ACTUAL && parseInt(mes) === MES_ACTUAL) {
            totalPagadoMesActual = pagosPorMes[keyMes].reduce((acc, p) => acc + p.monto, 0);
          }
        }

        totalPagadoSpan.textContent = formatoMoneda(totalPagadoMesActual);
        if (totalPagadoMesActual >= MONTO_MENSUAL_ESPERADO) {
          estadoPagoDetalleSpan.innerHTML = `<span class="status-pagado">Pagado</span>`;
        } else if (totalPagadoMesActual > 0) {
          estadoPagoDetalleSpan.innerHTML = `<span class="status-menor-pago">Pago incompleto</span>`;
        } else {
          estadoPagoDetalleSpan.innerHTML = `<span class="status-no-pagado">No pagado</span>`;
        }
      } catch (error) {
        alert('Error al cargar pagos: ' + error.message);
      }
    }

    // Volver a lista estudiantes desde detalle pagos
    function volverAEstudiantes() {
      estudianteSeleccionado = null;
      showSection('estudiantes');
    }

    // Eliminar pago
    async function eliminarPago(idPago) {
      if (!confirm('¿Seguro que quieres eliminar este pago? Esta acción no se puede deshacer.')) return;
      try {
        await deleteDoc(doc(db, 'pagos', idPago));
        alert('Pago eliminado.');
        if (estudianteSeleccionado) {
          // Recargar detalle pagos
          const est = estudiantesCache.find(e => e.id === estudianteSeleccionado);
          if (est) {
            verPagosEstudiante(estudianteSeleccionado, est.nombre);
          }
        } else {
          cargarEstudiantes();
        }
      } catch (error) {
        alert('Error al eliminar pago: ' + error.message);
      }
    }

    // --- FINANZAS ---

    // Calcular ingresos, egresos y balance
    async function calcularFinanzas() {
      let totalIngresos = 0;
      let totalEgresos = 0;

      try {
        // Calcular total ingresos (sumar todos los pagos)
        const pagosSnapshot = await getDocs(collection(db, 'pagos'));
        pagosSnapshot.forEach(docSnap => {
          const pago = docSnap.data();
          totalIngresos += pago.monto;
        });

        // Calcular total egresos
        const egresosSnapshot = await getDocs(collection(db, 'egresos'));
        egresosCache = [];
        egresosSnapshot.forEach(docSnap => {
          const egreso = { id: docSnap.id, ...docSnap.data() };
          egresosCache.push(egreso);
          totalEgresos += egreso.monto;
        });

        totalIngresosSpan.textContent = formatoMoneda(totalIngresos);
        totalEgresosSpan.textContent = formatoMoneda(totalEgresos);
        balanceSpan.textContent = formatoMoneda(totalIngresos - totalEgresos);
      } catch (error) {
        alert('Error al calcular finanzas: ' + error.message);
      }
    }

    // --- EGRESOS ---

    // Registrar egreso nuevo
    async function registrarEgreso() {
      const descripcion = document.getElementById('descripcion-egreso').value.trim();
      const montoStr = document.getElementById('monto-egreso').value.trim();
      const monto = Number(montoStr);

      if (descripcion.length < 3) {
        alert('Ingrese una descripción válida.');
        return;
      }
      if (isNaN(monto) || monto <= 0) {
        alert('Ingrese un monto válido mayor a 0.');
        return;
      }

      try {
        await addDoc(collection(db, 'egresos'), {
          descripcion,
          monto,
          fecha: new Date()
        });
        alert('Egreso registrado.');
        document.getElementById('descripcion-egreso').value = '';
        document.getElementById('monto-egreso').value = '';
        cargarEgresos();
        calcularFinanzas();
      } catch (error) {
        alert('Error al registrar egreso: ' + error.message);
      }
    }

    // Cargar egresos y mostrar tabla
    function cargarEgresos() {
      tablaEgresosBody.innerHTML = '';
      if (egresosCache.length === 0) {
        tablaEgresosBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay egresos registrados.</td></tr>';
        return;
      }
      // Ordenar egresos descendente por fecha
      const egresosOrdenados = egresosCache.sort((a,b) => b.fecha.toDate ? b.fecha.toDate() - a.fecha.toDate() : new Date(b.fecha) - new Date(a.fecha));

      for (const egreso of egresosOrdenados) {
        const fecha = egreso.fecha.toDate ? egreso.fecha.toDate() : new Date(egreso.fecha);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatFecha(fecha)}</td>
          <td>${escapeHtml(egreso.descripcion)}</td>
          <td>${formatoMoneda(egreso.monto)}</td>
          <td>
            <button class="boton-eliminar-egreso" onclick="eliminarEgreso('${egreso.id}')">Eliminar</button>
          </td>
        `;
        tablaEgresosBody.appendChild(tr);
      }
    }

    // Eliminar egreso
    async function eliminarEgreso(idEgreso) {
      if (!confirm('¿Seguro que quieres eliminar este egreso? Esta acción no se puede deshacer.')) return;
      try {
        await deleteDoc(doc(db, 'egresos', idEgreso));
        alert('Egreso eliminado.');
        egresosCache = egresosCache.filter(e => e.id !== idEgreso);
        cargarEgresos();
        calcularFinanzas();
      } catch (error) {
        alert('Error al eliminar egreso: ' + error.message);
      }
    }

    // --- UTILIDADES ---

    // Escapar html para evitar XSS
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    // Formato moneda COP
    function formatoMoneda(valor) {
      return valor.toLocaleString('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 });
    }

    // Formato fecha DD/MM/YYYY
    function formatFecha(fecha) {
      if (!(fecha instanceof Date)) return '';
      const d = fecha.getDate().toString().padStart(2, '0');
      const m = (fecha.getMonth() + 1).toString().padStart(2, '0');
      const y = fecha.getFullYear();
      return `${d}/${m}/${y}`;
    }

    // Capitalizar primera letra
    function capitalize(text) {
      if (!text) return '';
      return text.charAt(0).toUpperCase() + text.slice(1);
    }

  </script>
</body>
</html>
